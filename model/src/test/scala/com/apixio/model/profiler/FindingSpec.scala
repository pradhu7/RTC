package com.apixio.model.profiler

import com.apixio.model.event.transformer.EventTypeListJSONParser
import com.apixio.model.utils.TestUtils
import com.fasterxml.jackson.core.JsonParser
import com.fasterxml.jackson.databind.{DeserializationFeature, ObjectMapper}
import com.fasterxml.jackson.module.scala.DefaultScalaModule
import com.fasterxml.jackson.module.scala.ScalaObjectMapper
import org.junit.runner.RunWith
import org.scalatestplus.junit.JUnitRunner
import org.scalatest.flatspec.AnyFlatSpec
import org.scalatest._
import matchers.should._

import scala.collection.JavaConverters._
import org.joda.time.DateTime

@RunWith(classOf[JUnitRunner])
class FindingSpec extends AnyFlatSpec with Matchers {

  implicit val mapper = {
    val m = new ObjectMapper() with ScalaObjectMapper
    m.registerModule(DefaultScalaModule)
    m.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)
    m.configure(JsonParser.Feature.ALLOW_SINGLE_QUOTES, true)
    m
  }
  CodeMapping.init(TestUtils.getCodeMappingIfNotExist(TestUtils.CODE_MAPPING))

  "Finding" should "rollup state from annotations" in {
    val raw = """{"eventTypes":[{"attributes":{"$patientUUID":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e","sourceType":"USER_ANNOTATION","$kafka":"events:0:1805719:1464217394988","HCC_APP_VERSION":"5.9.2","SOURCE_TYPE":"USER_ANNOTATION","$documentUUID":"5e018bef-550d-44a9-8917-9f1f0c112054"},"source":{"type":"document","uri":"5e018bef-550d-44a9-8917-9f1f0c112054"},"evidence":{"source":{"type":"user","uri":"bmacaraig@apexcodemine.com"},"inferred":false,"attributes":{"comment":"fistula was surgically created for hemodialysis.","presentedHcc":"108","code":"","sweep":"finalReconciliation","hccDescription":"Vascular Disease","presentedHccModelPaymentYear":"2016","presentedTag":"qa2","dateOfService":"03/03/2015","encounterType":"","physicianFirstName":"","hcc":"108","codingOrganization":"UO_ba0e1b58-2e51-420f-b0a4-6bd8b518a8a9","codeSystem":"","physicianLastName":"","pageNumber":"","presentedHccSweep":"finalReconciliation","hccPaymentYear":"2016","project":"CP_730e3b40-4408-4f54-84fd-7e264864e6a5","modelPaymentYear":"2016","timestamp":"2016-05-26T00:03:02.528738Z","presentedState":"accepted_qa1","presentedHccDescription":"Vascular Disease","presentedHccLabelSetVersion":"V22","presentedHccMappingVersion":"2016 finalReconciliation","codeSystemVersion":"","NPI":"","physicianMiddleName":"","suggestedPages":"1","reviewFlag":"true","organization":"10000377","transactionId":"7a2bc29c-48f3-4cde-8848-61f0f9045b07"}},"fact":{"code":{"codeSystemVersion":"","code":"4470","displayName":"","codeSystem":"2.16.840.1.113883.6.103"},"values":{"rejectReason":"This document does not mention this HCC","result":"reject"},"time":{"endTime":"2015-03-03T00:00:00+0000","startTime":"2015-03-03T00:00:00+0000"}},"subject":{"type":"patient","uri":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e"}},{"attributes":{"$patientUUID":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e","sourceType":"USER_ANNOTATION","$kafka":"events:0:1805363:1464025744624","HCC_APP_VERSION":"5.9.2","SOURCE_TYPE":"USER_ANNOTATION","$documentUUID":"5e018bef-550d-44a9-8917-9f1f0c112054"},"source":{"type":"document","uri":"5e018bef-550d-44a9-8917-9f1f0c112054"},"evidence":{"source":{"type":"user","uri":"bmacaraig@apexcodemine.com"},"inferred":false,"attributes":{"comment":"fistula was surgically created for hemodialysis.","presentedHcc":"108","code":"","sweep":"finalReconciliation","hccDescription":"Vascular Disease","presentedHccModelPaymentYear":"2016","presentedTag":"qa2","physicianLastName":"","dateOfService":"03/03/2015","encounterType":"","physicianFirstName":"","codingOrganization":"UO_ba0e1b58-2e51-420f-b0a4-6bd8b518a8a9","codeSystem":"","hcc":"108","pageNumber":"","presentedHccSweep":"finalReconciliation","hccPaymentYear":"2016","reviewFlag":"true","modelPaymentYear":"2016","timestamp":"2016-05-23T17:49:03.915919Z","presentedState":"accepted_qa1","presentedHccDescription":"Vascular Disease","presentedHccLabelSetVersion":"V22","presentedHccMappingVersion":"2016 finalReconciliation","codeSystemVersion":"","NPI":"","physicianMiddleName":"","suggestedPages":"1","project":"CP_730e3b40-4408-4f54-84fd-7e264864e6a5","organization":"10000377","transactionId":"7a2bc29c-48f3-4cde-8848-61f0f9045b07"}},"fact":{"code":{"codeSystemVersion":"","code":"4470","displayName":"","codeSystem":"2.16.840.1.113883.6.103"},"values":{"rejectReason":"This document does not mention this HCC","result":"reject"},"time":{"endTime":"2015-03-03T00:00:00+0000","startTime":"2015-03-03T00:00:00+0000"}},"subject":{"type":"patient","uri":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e"}},{"attributes":{"$patientUUID":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e","sourceType":"USER_ANNOTATION","$kafka":"events:0:1805346:1464022392361","HCC_APP_VERSION":"5.9.2","SOURCE_TYPE":"USER_ANNOTATION","$documentUUID":"5e018bef-550d-44a9-8917-9f1f0c112054"},"source":{"type":"document","uri":"5e018bef-550d-44a9-8917-9f1f0c112054"},"evidence":{"source":{"type":"user","uri":"bkrebs@apixio.com"},"inferred":false,"attributes":{"comment":"Doc as AV fistula.","presentedHcc":"108","code":"4470","sweep":"finalReconciliation","hccDescription":"Vascular Disease","presentedHccModelPaymentYear":"2016","presentedTag":"qa1","dateOfService":"03/03/2015","encounterType":"Physician Face-to-Face Encounter","physicianFirstName":"","hcc":"108","codingOrganization":"UO_ba0e1b58-2e51-420f-b0a4-6bd8b518a8a9","codeSystem":"","physicianLastName":"","pageNumber":"","presentedHccSweep":"finalReconciliation","hccPaymentYear":"2016","project":"CP_730e3b40-4408-4f54-84fd-7e264864e6a5","modelPaymentYear":"2016","timestamp":"2016-05-23T17:52:55.792000Z","presentedState":"accepted","presentedHccDescription":"Vascular Disease","presentedHccLabelSetVersion":"V22","presentedHccMappingVersion":"2016 finalReconciliation","codeSystemVersion":"","NPI":"","physicianMiddleName":"","suggestedPages":"1","reviewFlag":"true","organization":"10000377","transactionId":"de7aa086-be77-47ba-a692-d190c447a7b8"}},"fact":{"code":{"codeSystemVersion":"","code":"4470","displayName":"Arteriovenous fistula, acquired","codeSystem":"2.16.840.1.113883.6.103"},"values":{"rejectReason":"","result":"accept"},"time":{"endTime":"2015-03-03T00:00:00+0000","startTime":"2015-03-03T00:00:00+0000"}},"subject":{"type":"patient","uri":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e"}},{"attributes":{"$patientUUID":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e","sourceType":"USER_ANNOTATION","$kafka":"events:0:1794794:1463707758658","HCC_APP_VERSION":"5.9.2","SOURCE_TYPE":"USER_ANNOTATION","$documentUUID":"5e018bef-550d-44a9-8917-9f1f0c112054"},"source":{"type":"document","uri":"5e018bef-550d-44a9-8917-9f1f0c112054"},"evidence":{"source":{"type":"user","uri":"ndagdagan@apexcodemine.com"},"inferred":false,"attributes":{"comment":"Doc as AV fistula.","presentedHcc":"108","code":"4470","sweep":"finalReconciliation","hccDescription":"Vascular Disease","presentedHccModelPaymentYear":"2016","presentedTag":"","physicianLastName":"","dateOfService":"03/03/2015","encounterType":"Physician Face-to-Face Encounter","physicianFirstName":"","codingOrganization":"UO_ba0e1b58-2e51-420f-b0a4-6bd8b518a8a9","codeSystem":"","hcc":"108","pageNumber":"","presentedHccSweep":"finalReconciliation","hccPaymentYear":"2016","reviewFlag":"true","modelPaymentYear":"2016","timestamp":"2016-05-20T01:29:18.033713Z","presentedState":"routable","presentedHccDescription":"Vascular Disease","presentedHccLabelSetVersion":"V22","presentedHccMappingVersion":"2016 finalReconciliation","codeSystemVersion":"","NPI":"","physicianMiddleName":"","suggestedPages":"1","project":"CP_730e3b40-4408-4f54-84fd-7e264864e6a5","organization":"10000377","transactionId":"de7aa086-be77-47ba-a692-d190c447a7b8"}},"fact":{"code":{"codeSystemVersion":"","code":"4470","displayName":"Arteriovenous fistula, acquired","codeSystem":"2.16.840.1.113883.6.103"},"values":{"rejectReason":"","result":"accept"},"time":{"endTime":"2015-03-03T00:00:00+0000","startTime":"2015-03-03T00:00:00+0000"}},"subject":{"type":"patient","uri":"c9b99bb8-654f-4043-a78a-4fcedf7b9e2e"}}]}"""
    val events = (new EventTypeListJSONParser()).parseEventsData(raw).asScala.map(x => Annotation(EventTypeX(x))).toList
    var f : Finding = Finding(startDos = DateTime.parse("2015-01-01T00:00:00+0000"), endDos = DateTime.parse("2015-12-31T00:00:00+0000"))
    events.foreach{ e =>
      f = f.applyAnnotation(e)
    }
    f = f.pack
    f.state should equal (Finding.REJECTED)
    f.annotations.last.winner should equal (true)
  }

  it should "prioritize suggested pages" in {
    val raw = """{"eventTypes":[{"attributes":{"bucketType":"maxentModel.v0.0.5a","$jobId":"8417534","$patientUUID":"050e19a3-85d4-4690-a05d-de934eb909be","$orgId":"10000385","sourceType":"NARRATIVE","$documentId":"some_doc","$documentUUID":"346a21fe-015d-4a07-9f86-d0a81630bb54","editType":"ACTIVE","editTimestamp":"2016-06-14T19:02:15.096Z","$workId":"8399858","bucketName":"maxentModel.v0.0.5a.ex6d_big_idf_LDADateExtract20150820_newf2f_apxcatv22","totalPages":"94","$batchId":"some_batch","$propertyVersion":"1466020205018"},"source":{"type":"document","uri":"346a21fe-015d-4a07-9f86-d0a81630bb54"},"evidence":{"source":{"type":"v5apxcat2","uri":"maxentv5Model"},"inferred":true,"attributes":{"appliedDateExtraction":"true","mentionDictionary":"apxcat_dict_20160610.txt","hasMention":"YES","spellChecking":"false","title":"some_title","face2face":"true","junkiness":"0.8376383763837638","patternsFile":"negation_triggers_20140211.txt","associatedEncounter":"Apixio:UNKNONW_ENCOUNTER","snippet":"hypertensive heart disease|pulmonary hypertension|hypertensive heart disease|pulmonary hypertension","pageNumber":"24","mentions":"hypertensive heart disease|pulmonary hypertension|hypertensive heart disease|pulmonary hypertension","face2faceConfidence":"0.9994138957817833","extractionType":"plainText","predictionConfidence":"0.8217100679392277"}},"fact":{"code":{"codeSystemVersion":"2.0","code":"V22_85","displayName":"Congestive Heart Failure","codeSystem":"APXCAT"},"time":{"endTime":"2015-01-03T00:00:00+0000","startTime":"2015-01-03T00:00:00+0000"}},"subject":{"type":"patient","uri":"050e19a3-85d4-4690-a05d-de934eb909be"}},{"attributes":{"bucketType":"dictionary.v0.1","$jobId":"8343995","$patientUUID":"050e19a3-85d4-4690-a05d-de934eb909be","$orgId":"10000385","sourceType":"NARRATIVE","encHash":"ezh+r1y0xoz4+HDoBCiFCg==","$documentId":"some_doc","$documentUUID":"346a21fe-015d-4a07-9f86-d0a81630bb54","editType":"ACTIVE","editTimestamp":"2016-06-14T19:02:15.096Z","$workId":"8311176","bucketName":"dictionary.v0.1.ex6d_big_idf_LDADateExtract20150820_newf2f_apxcatv22","totalPages":"94","$batchId":"some_batch","$propertyVersion":"1465350542365"},"source":{"type":"document","uri":"346a21fe-015d-4a07-9f86-d0a81630bb54"},"evidence":{"source":{"type":"dictionary","uri":"apxcat_dict_20160119.txt"},"inferred":true,"attributes":{"appliedDateExtraction":"true","hasMention":"YES","spellChecking":"false","title":"some_title","face2face":"true","junkiness":"0.8","associatedEncounter":"Apixio:UNKNONW_ENCOUNTER","extracted_2015_9":"0.32731167687304824","snippet":"chf|nonischemic cardiomyopathy|hypertensive heart disease|pulmonary hypertension","f2fConfidence":"0.9993080595197315","pageNumber":"26","mentions":"chf|nonischemic cardiomyopathy|hypertensive heart disease|pulmonary hypertension","patternsFile":"negation_triggers_20140211.txt","extractionType":"plainText","predictionConfidence":"1"}},"fact":{"code":{"codeSystemVersion":"2.0","code":"V22_85","displayName":"chf","codeSystem":"APXCAT"},"time":{"endTime":"2015-09-03T00:00:00+0000","startTime":"2015-09-03T00:00:00+0000"}},"subject":{"type":"patient","uri":"050e19a3-85d4-4690-a05d-de934eb909be"}}]}"""
    val events = (new EventTypeListJSONParser()).parseEventsData(raw).asScala.map(x => EventTypeX(x)).toList
    val f = Finding.hcc(Code("85","HCCV22"), events, events.head.fact.time.start, events.head.fact.time.end, List(), (0,null), false)
    f.pages should equal (List(24))
  }

  it should "size limit prioritized suggested pages" in {
    val raw = """{"eventTypes":[{"attributes":{"bucketType":"maxentModel.v0.0.5a","$jobId":"8417534","$patientUUID":"050e19a3-85d4-4690-a05d-de934eb909be","$orgId":"10000385","sourceType":"NARRATIVE","$documentId":"some_doc","$documentUUID":"346a21fe-015d-4a07-9f86-d0a81630bb54","editType":"ACTIVE","editTimestamp":"2016-06-14T19:02:15.096Z","$workId":"8399858","bucketName":"maxentModel.v0.0.5a.ex6d_big_idf_LDADateExtract20150820_newf2f_apxcatv22","totalPages":"94","$batchId":"some_batch","$propertyVersion":"1466020205018"},"source":{"type":"document","uri":"346a21fe-015d-4a07-9f86-d0a81630bb54"},"evidence":{"source":{"type":"v5apxcat2","uri":"maxentv5Model"},"inferred":true,"attributes":{"appliedDateExtraction":"true","mentionDictionary":"apxcat_dict_20160610.txt","hasMention":"YES","spellChecking":"false","title":"some_title","face2face":"true","junkiness":"0.8376383763837638","patternsFile":"negation_triggers_20140211.txt","associatedEncounter":"Apixio:UNKNONW_ENCOUNTER","snippet":"hypertensive heart disease|pulmonary hypertension|hypertensive heart disease|pulmonary hypertension","pageNumber":"276","mentions":"hypertensive heart disease|pulmonary hypertension|hypertensive heart disease|pulmonary hypertension","face2faceConfidence":"0.9994138957817833","extractionType":"plainText","predictionConfidence":"0.8217100679392277"}},"fact":{"code":{"codeSystemVersion":"2.0","code":"V22_85","displayName":"Congestive Heart Failure","codeSystem":"APXCAT"},"time":{"endTime":"2015-01-03T00:00:00+0000","startTime":"2015-01-03T00:00:00+0000"}},"subject":{"type":"patient","uri":"050e19a3-85d4-4690-a05d-de934eb909be"}}]}"""
    val event = (new EventTypeListJSONParser()).parseEventsData(raw).asScala.map(x => EventTypeX(x)).toList.head
    val otherPages = List(277,351,353,403,408,484,486,488,507,509,510,511,513,516,517,518,521,551,558,627,629,630,631,632,633,634,635,636,638,639,640,657,687,693,695,725,728,735,762,782,822,836)
    val events = List(event) ++ otherPages.map(p => event.copy(evidence = event.evidence.copy(attributes = event.evidence.attributes ++ Map("pageNumber" -> p.toString))))
    val f = Finding.hcc(Code("85","HCCV22"), events, events.head.fact.time.start, events.head.fact.time.end, List(), (0,null), false)
    f.pages should equal (List(276,351,403,408,484,488,507,510,513,516,521,551,558,627,630,633,636,639,657,687,693,725,728,735,762,782,822,836))
  }

  it should "make manual findings" in {
    val raw = """{"eventTypes":[{"attributes":{"$patientUUID":"050e19a3-85d4-4690-a05d-de934eb909be","$orgId":"10000385","sourceType":"NARRATIVE","editType":"ACTIVE","editTimestamp":"2016-06-14T19:02:15.096Z","$documentId":"some_doc","$documentUUID":"346a21fe-015d-4a07-9f86-d0a81630bb54","$batchId":"some_batch"},"evidence":{"source":{"type":"user","uri":"slydon@apixio.com"},"inferred":true,"attributes":{"tag":"manual","title":"some_title"}},"subject":{"type":"patient","uri":"050e19a3-85d4-4690-a05d-de934eb909be"},"fact":{"code":{"codeSystemVersion":"","code":"HCCV22","displayName":"","codeSystem":"2.16.840.1.113883.6"},"time":{"endTime":"2015-01-03T00:00:00+0000","startTime":"2015-01-03T00:00:00+0000"}},"source":{"type":"document","uri":"346a21fe-015d-4a07-9f86-d0a81630bb54"}}]}"""
    val events = (new EventTypeListJSONParser()).parseEventsData(raw).asScala.map(x => EventTypeX(x)).toList
    val f = Finding.manual(events, DateTime.parse("2014-01-01T00:00:00+0000"), DateTime.parse("2016-12-31T00:00:00+0000"), List())
    f.tags should equal (List("manual"))
    f.state should equal (Finding.ROUTABLE)
  }
}
